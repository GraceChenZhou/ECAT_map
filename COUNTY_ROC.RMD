---
title: "Predictions of Rapid Cystic Fibrosis Lung Disease Progression Informed by Socioeconomic Deprivation and Traffic-Related Air Pollution Exposure"
subtitle: "Geomarkers' impacts on rate of change: Hamilton County"
author: "Grace C. Zhou"
date:   'Update: `r format(Sys.Date(), "%B %d, %Y")`'
header-includes:
   - \usepackage{bbm}
output:
  html_document: 
    df_print: paged
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: TRUE
    fig_caption: yes
    theme: flatly
bibliography: ECAT_refs.bib
link-citations: yes
---

```{r setup,echo=FALSE,warning = FALSE, message= FALSE}

knitr::opts_chunk$set(cache = TRUE, echo=FALSE,
                      warning = FALSE, message= FALSE)

library(rmarkdown)
library(dplyr)
library(tmap)
library(leaflet)

indata <- readRDS('DATA/Hamilton_Data.rds')
ZipCode <- readRDS('DATA/Hamilton_Zipcode.rds')

#Function
##Reference:https://rdrr.io/github/r-spatial/leafem/src/R/homebutton.R#sym-addZoomFullButton
addHomeButton <- function(map, ext, group = "layer",
                          position = 'bottomright', add = TRUE) {
  
  leafletHomeButtonDependencies <- function() {
    list(
      htmltools::htmlDependency(
        "HomeButton",
        '0.0.1',
        system.file("htmlwidgets/lib/HomeButton", package = "leafem"),
        script = c("home-button.js", 'easy-button-src.min.js'),
        stylesheet = 'home-button.css'
      ))
  }
  
  if (inherits(map, "mapview")) map <- mapview2leaflet(map)
  stopifnot(inherits(map, c("leaflet", "leaflet_proxy")))
  
  # drop names in case extent of sf object
  if (!missing(ext)) {
    if (inherits(ext, "Extent")) {
      ext = as.vector(ext)[c(1, 3, 2, 4)]
    } else {
      ext = as.vector(ext)
    }
    useext = TRUE
  } else {
    ext = c(0, 0, 0, 0)
    useext = FALSE
  }
  
  hb <- try(getCallEntryFromMap(map, "addHomeButton"), silent = TRUE)
  if (!inherits(hb, "try-error") & length(hb) == 1) {
    ext_coords <- unlist(map$x$calls[[hb]][["args"]][1:4])
    ext_map <- c(ext_coords[1], ext_coords[2], ext_coords[3], ext_coords[4])
    if (identical(ext, ext_map)) add = FALSE
  }
  
  if (add) {
    
    label <- paste("Zoom to Center")
    
    txt <- paste('<strong>', 'C', '</strong>')
    
    map$dependencies <- c(map$dependencies, leafletHomeButtonDependencies())
    leaflet::invokeMethod(map, leaflet::getMapData(map), 'addHomeButton',
                          ext[1],ext[2],ext[3],ext[4],
                          useext, group, label, txt, position)
  }
  
  else map
  
}


```

# Introduction

This plot was generated by the subset data for Hamilton County ONLY with a total of `r nrow(indata)` observations.

# Overall Impact

```{r OV}

CountyData=indata %>% select(.,starts_with("change_"),drive_time) %>% 
  mutate(ECAT=round(change_ecat,2),
         `Deprivation Index`=round(change_depind,2),
         Drive=paste0(round(change_drive,2), '(', drive_time,' mins)'),
         Green=round(change_green,2),
         Overall=round(change_total,2))

limit=range(CountyData$ECAT,CountyData$`Deprivation Index`,CountyData$Overall)


tmap_mode("view") #interactive plot
map.OV <- tm_basemap('CartoDB.Positron') +
  tm_shape(CountyData) +
  tm_polygons(col = 'Overall', palette = "RdYlGn", breaks=seq(from=limit[1],to=limit[2],length.out=5),
              border.col = NA,interactive = TRUE, style = "cont", alpha=0.5, 
              border.alpha = 0,lwd = .01, id='Overall',
              popup.vars=c('ECAT'='ECAT',
                           'Dep. Index'='Deprivation Index',
                           'Green'='Green',
                           'Drive'='Drive'))+
  tm_shape(ZipCode)+
    tm_borders(col='dark gray')+
    tm_text('ZCTA5CE10',size=0.7)


map.OV %>% 
  tmap_leaflet()  %>% 
  addHomeButton(group='CountyData',position='topleft') %>% 
   leaflet::addEasyButton(easyButton(
    icon='fa-crosshairs',title='Locate Me',
    onClick=JS('function(btn,map){map.locate({setView:true});}')))

```
********************************************************************************
# ECAT Impact

```{r ECAT}

tmap_mode("view")
map.ECAT <- tm_basemap('CartoDB.Positron') +
    tm_shape(CountyData) +
    tm_polygons(col = 'ECAT', palette = "RdYlGn",
                breaks=seq(from=limit[1],to=limit[2],length.out=5),
                border.col = NA,interactive = TRUE,style = "cont", alpha=0.5,
                border.alpha = 0,lwd = .01, id='ECAT',
                popup.vars=c('Dep. Index'='Deprivation Index',
                              'Green'='Green',
                              'Drive'='Drive',
                              'Overall'='Overall'))+
  tm_shape(ZipCode)+
    tm_borders(col='dark gray')+
    tm_text('ZCTA5CE10',size=0.7)


map.ECAT %>%
  tmap_leaflet()  %>%
  addHomeButton(group='CountyData',position='topleft') %>%
   leaflet::addEasyButton(easyButton(
    icon='fa-crosshairs',title='Locate Me',
    onClick=JS('function(btn,map){map.locate({setView:true});}')))

```
********************************************************************************
# Deprivation Index Impact

```{r DEP}

tmap_mode("view")
map.DPI <- tm_basemap('CartoDB.Positron') +
  tm_shape(CountyData) +
    tm_polygons(col = 'Deprivation Index', palette = "RdYlGn",
                 breaks=seq(from=limit[1],to=limit[2],length.out=5),
                 border.col = NA,interactive = TRUE,style = "cont", alpha=0.5,
                 border.alpha = 0,lwd = .01, id='Deprivation Index',
                 popup.vars=c('ECAT'='ECAT',
                              'Green'='Green',
                              'Drive'='Drive',
                              'Overall'='Overall'))+
  tm_shape(ZipCode)+
    tm_borders(col='dark gray')+
    tm_text('ZCTA5CE10',size=0.7)


map.DPI %>%
  tmap_leaflet()  %>%
  addHomeButton(group='CountyData',position='topleft') %>%
   leaflet::addEasyButton(easyButton(
    icon='fa-crosshairs',title='Locate Me',
    onClick=JS('function(btn,map){map.locate({setView:true});}')))

```
********************************************************************************
# Green Space Impact

```{r GREEN}

tmap_mode("view")
map.GN <- tm_basemap('CartoDB.Positron') +
  tm_shape(CountyData) +
    tm_polygons(col = 'Green', palette = "RdYlGn",
                breaks=seq(from=limit[1],to=limit[2],length.out=5),
              border.col = NA,interactive = TRUE,style = "cont", alpha=0.5,
              border.alpha = 0,lwd = .01, id='Green',
              popup.vars=c('ECAT'='ECAT',
                           'Dep. Index'='Deprivation Index',
                           'Drive'='Drive',
                           'Overall'='Overall'))+
  tm_shape(ZipCode)+
    tm_borders(col='dark gray')+
    tm_text('ZCTA5CE10',size=0.7)


map.GN %>%
  tmap_leaflet()  %>%
  addHomeButton(group='CountyData',position='topleft') %>%
   leaflet::addEasyButton(easyButton(
    icon='fa-crosshairs',title='Locate Me',
    onClick=JS('function(btn,map){map.locate({setView:true});}')))

```
********************************************************************************
# Drive time

```{r DRIVE}

tmap_mode("view")
map.DVT <- tm_basemap('CartoDB.Positron') +
  tm_shape(CountyData) +
    tm_polygons(col = 'Drive', palette = "RdYlGn",
                breaks=seq(from=limit[1],to=limit[2],length.out=5),
              border.col = NA,interactive = TRUE,style = "cont", alpha=0.5,
              border.alpha = 0,lwd = .01, id='Drive',
              popup.vars=c('ECAT'='ECAT',
                           'Dep. Index'='Deprivation Index',
                           'Green'='Green',
                           'Overall'='Overall'))+
  tm_shape(ZipCode)+
    tm_borders(col='dark gray')+
    tm_text('ZCTA5CE10',size=0.7)

map.DVT %>%
  tmap_leaflet()  %>%
  addHomeButton(group='CountyData',position='topleft') %>%
   leaflet::addEasyButton(easyButton(
    icon='fa-crosshairs',title='Locate Me',
    onClick=JS('function(btn,map){map.locate({setView:true});}')))

```

********************************************************************************

# Notes

* This .html file was executed by R version 4.0.2 (2020-06-22)[@r_r_2020] with R package **tmap V3.3-2**[@tennekes_tmap_2018], **rmarkdown V2.9**[@allaire_rmarkdown_2021], **dplyr V1.0.5**[@wickham_dplyr_2021], **leaflet V2.0.4.1**[@cheng_leaflet_2021]. 

# References